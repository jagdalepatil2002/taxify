<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Invoice Analyzer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa !important;
        }
        .hidden {
            display: none !important;
        }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scale-in { animation: scale-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 flex items-center justify-center p-4">

    <!-- App Container -->
    <div id="app-container" class="w-full flex justify-center">
        <!-- All views will be rendered here by JavaScript -->
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg z-50">
        <!-- Message is set by JS -->
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-200">
                <h3 id="modal-title" class="text-xl font-bold text-black"></h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-black transition-colors rounded-full p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <main id="modal-body" class="p-6 overflow-y-auto"></main>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let state = {
                view: 'login', // 'login', 'register', 'dashboard', 'analyzing', 'summary'
                user: null,
                error: '',
                summaryData: null,
                history: [],
                activeSummarySection: null,
                countryCode: '+1',
                countrySearch: '',
                isCountryDropdownOpen: false,
                isPasswordVisible: false,
            };

            // --- MOCK DATA (UPDATED FOR CP23) ---
            const cp23MockData = {
                noticeType: 'CP23T',
                taxYear: '2018',
                noticeFor: 'JAMES Q. SPARROW',
                address: '22 BOULDER STREET HANSON, CT 00000-7253',
                ssn: 'nnn-nn-nnnn',
                amountDue: '$425.73',
                payBy: 'February 20, 2019',
                summary: {
                    title: 'Quick Overview of the Notice',
                    overview: "We changed your 2018 Form 1040 to match our record of your estimated tax payments, credits applied from another tax year, and payments received with an extension to file, if any. We changed the amount claimed as itemized deductions because your deduction for state and local taxes is more than the amount allowed for your filing status.",
                    keyPoints: [
                        "This is a CP23T notice regarding changes made by the IRS to your 2018 tax return.",
                        "Action Required: You must pay the amount due ($425.73) by February 20, 2019 to avoid additional penalties and interest."
                    ]
                },
                why: [
                    { title: "Notice Type: CP23T", text: "This notice is about changes to your 2018 Form 1040." },
                    { title: "Reason for Change", text: "We changed the amount claimed as itemized deductions on your tax return because your deduction for state and local taxes is more than the amount allowed for your filing status." },
                    { title: "What Happens Next?", text: "If you do not contact us within 60 days, the change will not be reversed and you must pay the additional tax. You may then file a claim for refund." }
                ],
                breakdown: {
                    items: [
                        { item: "Tax you owed", amount: "$1,828.00" },
                        { item: "Payments you made", amount: "-$1,624.00" },
                        { item: "Failure-to-file penalty", amount: "$135.00" },
                        { item: "Failure-to-pay penalty", amount: "$65.00" },
                        { item: "Interest charges", amount: "$21.73" },
                        { item: "Total Amount Due", amount: "$425.73", isTotal: true }
                    ],
                    notes: []
                },
                fix: {
                    steps: [
                        {
                            title: "If You Agree with the Changes",
                            points: [
                                "Pay the amount due of $425.73 by February 20, 2019.",
                                "Pay online at www.irs.gov/payments or mail a check with the payment stub.",
                                "Keep this notice with your tax records."
                            ]
                        },
                        {
                            title: "If You Disagree with the Changes",
                            points: [
                                "Call us at the number on the notice to review your account.",
                                "Have your tax return and payment records available when you call.",
                                "If you write to us, do so within 60 days to retain your appeal rights before payment."
                            ]
                        }
                    ]
                },
                paymentOptions: [
                    { icon: 'üåê', title: "Online Payment", details: ["Website: www.irs.gov/payments", "Amount Due: $425.73", "Options: Bank transfer, debit/credit card"] },
                    { icon: 'üìÖ', title: "Payment Plan Setup", details: ["Online: www.irs.gov/paymentplan", "Available if you cannot pay the full amount now."] },
                ],
                help: {
                    irsPhone: "800-829-1040",
                    tas: "The Taxpayer Advocate Service (TAS) can help protect your taxpayer rights. Visit www.taxpayeradvocate.irs.gov or call 1-877-777-4778."
                },
                emailTemplate: `Subject: Important: IRS Notice CP23T

Dear JAMES Q. SPARROW,

This email is to inform you about an important tax notice (CP23T) we have analyzed on your behalf.

Summary:
- Amount Due: $425.73
- Payment Deadline: February 20, 2019
- Reason: The IRS adjusted your 2018 Form 1040 to reflect their records of your estimated tax payments, credits, and payments received with an extension.  Specifically, the amount claimed as itemized deductions was changed because your deduction for state and local taxes exceeded the allowed amount for your filing status.  This resulted in an additional tax owed of $425.73.

We recommend reviewing the detailed breakdown and action steps in your portal. Please let us know if you have any questions.

Sincerely,
Your Tax Advisor`,
                irsResponseTemplate: `[Your Name/Company Name]
[Your Address]
[City, State, ZIP]
[Date]

Internal Revenue Service
[IRS Address from Notice]

Re: Notice Type CP23T
Taxpayer Name: JAMES Q. SPARROW
SSN: nnn-nn-nnnn

Dear Sir or Madam:

This letter is in response to the notice dated [Date on Notice].

[Choose one of the following paragraphs]

[If you AGREE with the notice:]
I agree with the proposed changes. Enclosed is my payment for the full amount of $425.73.

[If you DISAGREE with the notice:]
I do not agree with the proposed changes. The notice states that [Reason from notice]. However, [Provide a clear and concise explanation of why you disagree. For example: "this income was reported on Schedule C," or "this 1099 form is incorrect and I have attached a corrected version from the payer."]

Please see the enclosed documents for your review:
- [List of supporting documents, e.g., "A copy of the corrected 1099-INT"]
- [Another document]

Thank you for your time and consideration. I look forward to resolving this matter promptly.

Sincerely,

_________________________
JAMES Q. SPARROW`
            };
            const cp503cMockData = {
                noticeType: 'CP503C', taxYear: '2019', noticeFor: 'MICHAEL & JENNIFER L. RODRIGUEZ', address: '789 OAK STREET\nPHOENIX, AZ 85001-5678', ssn: 'NNN-NN-NNNN', amountDue: '$9,533.53', payBy: 'March 15, 2025',
                summary: { title: 'IRS Notice CP503 is a second reminder from the IRS', overview: "The IRS sent Notice CP503 because they haven't received payment or a response to earlier communications about your unpaid tax balance. This is the second reminder and encourages you to act promptly to avoid further penalties or enforced collection efforts, such as a federal tax lien.", keyPoints: ["This is your second notice regarding unpaid taxes", "Previous communications were sent but no response received", "Immediate action required to prevent escalation", "Risk of federal tax lien if unresolved"] },
                why: [{ title: "Notice Type: CP503", text: "This is your second reminder about unpaid taxes. The IRS has already sent you a first notice (CP501) which was not resolved." }, { title: "Tax Year: 2016", text: "The unpaid balance relates to your 2016 tax return (Form 1040A) filed for the tax year ending December 31, 2016." }, { title: "üö© What Happens Next?", text: "If this notice is not addressed, the IRS may take collection actions including liens, levies, or wage garnishment." }],
                breakdown: { items: [{ item: "Original amount owed", amount: "$9,444.07" }, { item: "Failure-to-pay penalty", amount: "$34.98" }, { item: "Interest charges", amount: "$54.48" }, { item: "Total Amount Due", amount: "$9,533.53", isTotal: true }], notes: [{ title: "Legal Framework", text: "Internal Revenue Code Section 6601: Authorizes interest on unpaid taxes from the due date until paid in full." }, { title: "Penalty Authority", text: "Internal Revenue Code Sections 6651 & 6654: Establish failure-to-pay penalties for late tax payments." }] },
                fix: { steps: [{ title: "Step 1: Review Your Records First", points: ["Verify all payments made: Check bank statements, canceled checks, and payment confirmations", "Review payment timing: Ensure payments were processed by the IRS before the due date"] }, { title: "Step 2: If You Agree with the Amount", points: ["Pay immediately to stop interest and penalties from accruing", "Set up installment agreement if you cannot pay in full"] }, { title: "If You Disagree with the Amount", points: ["Contact IRS immediately - don't wait for the deadline", "Gather documentation (returns, payment records, correspondence)"] }] },
                paymentOptions: [{ icon: 'üåê', title: "Online Payment", details: ["Website: www.irs.gov/payments", "Amount Due: $9,533.53", "Options: Bank transfer, debit/credit card", "Status: ‚úÖ Available 24/7"] }, { icon: 'üìû', title: "Phone Payment", details: ["Number: 1-888-PAY-1040", "Hours: 24/7 automated system", "Status: ‚úÖ Immediate processing"] }, { icon: 'üìÆ', title: "Mail Payment", details: ["Address: Internal Revenue Service P.O. Box 1218 Charlotte, NC 28201-1218", "Include: Payment voucher from notice", "Status: ‚ö†Ô∏è May be too slow for this notice"] }, { icon: 'üìÖ', title: "Payment Plan Setup", details: ["Online: www.irs.gov/paymentplan", "Setup Fee: $31 online, $149 phone/mail", "Status: ‚úÖ Prevents collection actions"] }],
                help: { irsPhone: "1-800-829-0922", tas: "The Taxpayer Advocate Service (TAS) can help protect your taxpayer rights. Visit www.taxpayeradvocate.irs.gov or call 1-877-777-4778." },
                emailTemplate: `Subject: Important: IRS Notice CP503

Dear JAMES & KAREN Q. HINDS,

This email is to inform you about an important tax notice (CP503) we have analyzed on your behalf.

Summary:
- Amount Due: $9,533.53
- Payment Deadline: February 20, 2017
- Reason: The IRS records show unpaid taxes for the tax year ended December 31, 2016 (Form 1040A).  The notice specifies that if the amount due ($9,533.53) isn't paid by February 20, 2017, interest will increase and additional penalties may apply.

We recommend reviewing the detailed breakdown and action steps in your portal. Please let us know if you have any questions.

Sincerely,
Your Tax Advisor`,
                irsResponseTemplate: `[Your Name/Company Name]
[Your Address]
[City, State, ZIP]
[Date]

Internal Revenue Service
[IRS Address from Notice]

Re: Notice Type CP503
Taxpayer Name: JAMES & KAREN Q. HINDS
SSN: NNN-NN-NNNN

Dear Sir or Madam:

This letter is in response to the notice dated [Date on Notice].

[Choose one of the following paragraphs]

[If you AGREE with the notice:]
I agree with the proposed changes. Enclosed is my payment for the full amount of $9,533.53.

[If you DISAGREE with the notice:]
I do not agree with the proposed changes. The notice states that [Reason from notice]. However, [Provide a clear and concise explanation of why you disagree. For example: "this income was reported on Schedule C," or "this 1099 form is incorrect and I have attached a corrected version from the payer."]

Please see the enclosed documents for your review:
- [List of supporting documents, e.g., "A copy of the corrected 1099-INT"]
- [Another document]

Thank you for your time and consideration. I look forward to resolving this matter promptly.

Sincerely,

_________________________
JAMES & KAREN Q. HINDS`
            };
            const countryCodes = [ { "name": "United States", "dial_code": "+1", "code": "US" }, { "name": "United Kingdom", "dial_code": "+44", "code": "GB" }, { "name": "Canada", "dial_code": "+1", "code": "CA" }, { "name": "Australia", "dial_code": "+61", "code": "AU" }, { "name": "Germany", "dial_code": "+49", "code": "DE" }];

            // --- UI SELECTORS ---
            const appContainer = document.getElementById('app-container');
            const toastEl = document.getElementById('toast');
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- UTILITY & RENDER FUNCTIONS ---
            const showToast = (message, type = 'success') => {
                toastEl.textContent = message;
                toastEl.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg z-50 animate-fade-in ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                setTimeout(() => { toastEl.className = 'hidden'; }, 3000);
            };

            const showModal = (title, content) => {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modalContainer.classList.remove('hidden');
            };

            const hideModal = () => {
                modalContainer.classList.add('hidden');
            };
            
            modalCloseBtn.addEventListener('click', hideModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) hideModal();
            });

            const copyToClipboard = (text) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Copied to clipboard!', 'success');
                } catch (err) {
                    showToast('Failed to copy.', 'error');
                }
            };

            // --- VIEW RENDERING ENGINE ---
            const renderView = () => {
                let content = '';
                switch(state.view) {
                    case 'login': content = renderAuthScreen(true); break;
                    case 'register': content = renderAuthScreen(false); break;
                    case 'dashboard': content = renderDashboardScreen(); break;
                    case 'analyzing': content = renderAnalyzingScreen(); break;
                    case 'summary': content = renderSummaryScreen(); break;
                    default: content = renderAuthScreen(true);
                }
                appContainer.innerHTML = content;
                attachEventListeners();
            };
            
            // --- HTML TEMPLATE FUNCTIONS ---
            const renderPasswordStrengthMeter = (password) => {
                let score = 0;
                if (!password) score = 0;
                else {
                    if (password.length >= 8) score++;
                    if (/[A-Z]/.test(password)) score++;
                    if (/[0-9]/.test(password)) score++;
                    if (/[^A-Za-z0-9]/.test(password)) score++;
                }
                const color = ['bg-slate-200', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'][score];
                const label = ['Too short', 'Weak', 'Fair', 'Good', 'Strong'][score];
                return `
                    <div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all ${color}" style="width: ${(score / 4) * 100}%"></div>
                        </div>
                        <p class="text-xs text-right text-slate-500 mt-1">${label}</p>
                    </div>`;
            };

            const renderAuthScreen = (isLogin) => {
                const filteredCountries = countryCodes.filter(c => c.name.toLowerCase().includes(state.countrySearch.toLowerCase()) || c.dial_code.includes(state.countrySearch));
                const countryListItems = filteredCountries.map(c => `<li data-code="${c.dial_code}" class="country-item px-4 py-2 text-slate-700 hover:bg-orange-100 cursor-pointer">${c.name} (${c.dial_code})</li>`).join('');

                return `
                    <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-slate-100 max-w-md w-full animate-fade-in">
                        <h2 class="text-3xl font-bold text-center text-black mb-2">${isLogin ? "Welcome Back" : "Create Account"}</h2>
                        <p class="text-center text-slate-500 mb-8">${isLogin ? "Please enter your details to sign in." : "Simplify your tax notices today."}</p>
                        <form id="auth-form" class="space-y-4">
                            ${!isLogin ? `
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" name="firstName" placeholder="First Name" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                    <input type="text" name="lastName" placeholder="Last Name" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                </div>
                                <input type="text" name="dob" placeholder="Date of Birth" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                <div class="flex">
                                    <div class="relative w-1/3">
                                        <button type="button" id="country-code-btn" class="w-full h-full bg-slate-50 border border-r-0 border-slate-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-orange-500 px-3 py-3 text-slate-700 flex justify-between items-center">
                                            <span>${state.countryCode}</span>
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                        </button>
                                        <div id="country-code-dropdown" class="${state.isCountryDropdownOpen ? '' : 'hidden'} absolute z-10 mt-1 w-72 bg-white border border-slate-300 rounded-md shadow-lg">
                                            <input type="text" id="country-search" placeholder="Search..." value="${state.countrySearch}" class="w-full px-3 py-2 border-b border-slate-200 focus:outline-none"/>
                                            <ul class="max-h-48 overflow-auto">${countryListItems}</ul>
                                        </div>
                                    </div>
                                    <input type="tel" name="mobileNumber" placeholder="Mobile Number" class="w-2/3 px-4 py-3 bg-white border border-slate-300 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                </div>
                            ` : ''}
                            <input type="email" name="email" placeholder="Email Address" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                            <div class="relative">
                                <input type="${state.isPasswordVisible ? 'text' : 'password'}" name="password" placeholder="Password" class="password-input w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                <button type="button" class="password-toggle absolute inset-y-0 right-0 px-3 flex items-center text-slate-500">
                                    <svg class="h-5 w-5 eye-icon ${state.isPasswordVisible ? 'hidden' : ''}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>
                                    <svg class="h-5 w-5 eye-off-icon ${state.isPasswordVisible ? '' : 'hidden'}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></svg>
                                </button>
                            </div>
                             ${!isLogin ? `
                                <div class="relative">
                                    <input type="${state.isPasswordVisible ? 'text' : 'password'}" name="confirmPassword" placeholder="Confirm Password" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                </div>
                                <div id="password-strength-meter-container"></div>
                            ` : ''}
                            <p class="text-red-500 text-sm text-center">${state.error}</p>
                            <button type="submit" class="w-full text-white font-semibold py-3 rounded-lg transition-colors shadow-md shadow-orange-200 !mt-6" style="background-color: #ff6b00;">
                                ${isLogin ? "Sign In" : "Create Account"}
                            </button>
                        </form>
                        <p class="text-center text-sm text-slate-600 mt-6">
                            ${isLogin ? "No account?" : "Already have an account?"}
                            <button class="switch-view-btn font-semibold hover:underline ml-1" style="color: #ff6b00;">${isLogin ? "Sign up" : "Sign in"}</button>
                        </p>
                    </div>
                `;
            };

            const renderDashboardScreen = () => {
                const historyItems = state.history.map(item => `
                    <li data-id="${item.id}" class="history-item flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:bg-orange-100 cursor-pointer transition-colors">
                        <div>
                            <p class="font-semibold text-black">${item.noticeFor}</p>
                            <p class="text-sm text-slate-500">Notice: ${item.noticeType}</p>
                        </div>
                        <span class="text-sm font-semibold" style="color: #ff6b00;">${item.amountDue}</span>
                    </li>
                `).join('');

                return `
                    <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-slate-100 max-w-4xl w-full animate-fade-in">
                        <header class="flex justify-between items-center mb-8">
                            <div>
                                <h1 class="text-3xl font-bold text-black">Dashboard</h1>
                                <p class="text-slate-500">Welcome back, ${state.user?.firstName || ''} ${state.user?.lastName || ''}!</p>
                            </div>
                            <div class="space-x-4">
                                <button class="profile-btn text-slate-500 hover:text-black font-semibold transition-colors">Profile</button>
                                <button class="logout-btn text-slate-500 hover:text-black font-semibold transition-colors">Sign Out</button>
                            </div>
                        </header>
                        <main class="grid lg:grid-cols-2 gap-8">
                            <section>
                                <h2 class="text-xl font-bold text-black mb-4">New Analysis</h2>
                                <div class="upload-area border-2 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all duration-300 border-slate-300 bg-white">
                                    <svg class="mx-auto h-16 w-16 mb-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></svg>
                                    <p class="mt-4 text-lg text-black font-semibold">Drop your PDF file here</p>
                                    <p class="text-sm text-slate-500 mt-1">or</p>
                                    <button type="button" class="select-file-btn mt-4 text-white font-semibold py-2 px-6 rounded-lg transition-colors" style="background-color: #ff6b00;">Select a File</button>
                                    <input type="file" class="file-input hidden" accept=".pdf" />
                                </div>
                            </section>
                            <section class="flex flex-col">
                                <h2 class="text-xl font-bold text-black mb-4">Analysis History</h2>
                                <div class="bg-white p-6 rounded-xl border-2 border-slate-200 flex-grow">
                                    ${state.history.length > 0 ? `<ul class="space-y-3">${historyItems}</ul>` : `<div class="flex items-center justify-center h-full"><p class="text-center text-slate-500">No past analyses found.</p></div>`}
                                </div>
                            </section>
                        </main>
                    </div>
                `;
            };

            const renderAnalyzingScreen = () => `
                <div class="flex flex-col items-center justify-center space-y-4 text-center">
                    <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4" style="border-color: #ff6b00;"></div>
                    <p class="text-black font-semibold text-lg">AI is analyzing your notice...</p>
                    <p class="text-slate-500">This may take a moment. Please don't close the window.</p>
                </div>
            `;

            const renderActiveSummarySectionContent = () => {
                if (!state.activeSummarySection) return '';
                const data = state.summaryData;
                let title, content;

                switch (state.activeSummarySection) {
                    case 'summary':
                        title = `Understanding Your Notice (${data.noticeType})`;
                        content = `<div>
                            <p class="text-slate-600 mb-4">${data.summary?.overview}</p>
                            <h4 class="font-bold text-black mb-2">Key Points:</h4>
                            <ul class="list-disc list-inside space-y-1 text-slate-600">
                                ${data.summary?.keyPoints?.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>`;
                        break;
                    case 'why':
                        title = "Why did I receive this?";
                        content = `<div>
                            ${data.why?.map(item => `<div class="mb-4 last:mb-0">
                                <h4 class="font-bold text-black">${item.title}</h4>
                                ${item.isClickable ? `<p class="text-slate-600 underline cursor-pointer hover:text-orange-500 salt-link">${item.text}</p>` : `<p class="text-slate-600">${item.text}</p>`}
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'breakdown':
                        title = "Amount Breakdown";
                        content = `<div>
                            <table class="w-full text-sm mb-4 text-black"><tbody>
                                ${data.breakdown?.items?.map(item => `<tr class="border-b ${item.isTotal ? 'font-bold' : ''}" style="border-color: #F1F5F9">
                                    <td class="p-2">${item.item}</td>
                                    <td class="p-2 text-right font-mono ${item.isTotal ? 'text-orange-500' : ''}">${item.amount}</td>
                                </tr>`).join('')}
                            </tbody></table>
                            <div class="space-y-4">
                                ${data.breakdown?.notes?.map(note => `<div><h5 class="font-bold text-black">${note.title}</h5><p class="text-sm text-slate-600">${note.text}</p></div>`).join('')}
                            </div>
                        </div>`;
                        break;
                    case 'fix':
                        title = "How should I fix this?";
                        content = `<div>
                            ${data.fix?.steps?.map(item => `<div class="mb-4 last:mb-0">
                                <h4 class="font-bold text-black">${item.title}</h4>
                                <ul class="list-disc list-inside text-slate-600">${item.points.map(p => `<li>${p}</li>`).join('')}</ul>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'payment':
                        title = "Payment Options";
                        content = `<div class="grid md:grid-cols-2 gap-4">
                            ${data.paymentOptions?.map(item => `<div class="bg-white p-4 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-black flex items-center gap-2"><span class="text-xl">${item.icon}</span>${item.title}</h4>
                                <ul class="text-sm text-slate-600 mt-2 space-y-1">${item.details.map(d => `<li>${d}</li>`).join('')}</ul>
                            </div>`).join('')}
                        </div>`;
                        break;
                    default: return '';
                }

                return `
                    <div class="transition-all duration-500 overflow-hidden rounded-lg bg-slate-50 max-h-screen animate-fade-in">
                        <div class="flex justify-between items-center p-4">
                            <h3 class="text-lg font-bold text-black flex items-center gap-4">
                                <span class="text-2xl" style="color: #ff6b00;">${{summary: 'üìÑ', why: '‚ùì', breakdown: 'üí≤', fix: '‚úîÔ∏è', payment: 'üí≥'}[state.activeSummarySection]}</span>
                                ${title}
                            </h3>
                            <button class="close-section-btn bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-600 transition-transform transform hover:scale-110 text-xl">√ó</button>
                        </div>
                        <div class="p-6 border-t border-slate-200">${content}</div>
                    </div>`;
            };

            const renderSummaryScreen = () => {
                const data = state.summaryData;
                if (!data) return '<p>Error: No summary data available.</p>';
                
                const infoTile = (id, icon, title, preview) => `
                    <div data-section-id="${id}" class="info-tile p-4 cursor-pointer transition-all duration-300 border rounded-lg hover:shadow-md hover:-translate-y-0.5 bg-white ${state.activeSummarySection === id ? 'border-orange-500' : 'border-slate-200'}">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl" style="color: #ff6b00;">${icon}</div>
                            <div class="flex-1">
                                <p class="text-base font-semibold text-black">${title}</p>
                                <p class="text-slate-500 text-sm">${preview}</p>
                            </div>
                            <div class="text-orange-500 transition-transform duration-300" style="transform: ${state.activeSummarySection === id ? 'rotate(90deg)' : ''}; color: #ff6b00;">‚ñ∂</div>
                        </div>
                    </div>`;

                return `
                    <div class="w-full font-sans animate-fade-in">
                         <div class="container max-w-4xl mx-auto">
                             <div class="header text-center mb-8">
                                 <h1 class="text-black text-4xl font-bold mb-2">IRS Notice Analysis</h1>
                                 <p class="text-slate-500 text-lg">Professional breakdown and action plan for your tax notice</p>
                             </div>
                             <div class="notice-container bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
                                 <div class="notice-header text-white p-8 text-center relative" style="background-color: #ff6b00;">
                                     <div class="notice-title text-2xl font-bold mb-4 relative z-10">Summary of Your ${data.taxYear} IRS Notice ${data.noticeType}</div>
                                     <div class="notice-type bg-white bg-opacity-20 px-4 py-2 rounded-full inline-block font-semibold relative z-10">Analysis Complete</div>
                                 </div>
                                 <div class="notice-body p-8">
                                     <div class="client-info bg-slate-50 rounded-xl p-6 mb-8 border-l-4" style="border-color: #ff6b00;">
                                         <div class="client-name text-xl font-bold text-black mb-1">${data.noticeFor}</div>
                                         <div class="client-address text-slate-600 mb-4 whitespace-pre-line">${data.address}</div>
                                         <div class="ssn-info text-sm text-slate-500">Social Security Number: ${data.ssn}</div>
                                         <div class="ssn-info text-sm mt-2 font-bold" style="color: #ff6b00;">Tax Year: ${data.taxYear}</div>
                                     </div>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                         <div class="p-6 rounded-xl text-white text-center shadow-lg flex flex-col justify-center" style="background: linear-gradient(135deg, #ff6b00 0%, #ff8533 100%);">
                                             <div class="text-sm opacity-90 mb-2">Total Amount Due</div>
                                             <div class="text-4xl font-bold mb-3">${data.amountDue}</div>
                                         </div>
                                         <div class="p-6 rounded-xl text-black text-center shadow-lg flex flex-col justify-center" style="background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);">
                                             <div class="text-sm opacity-80 mb-2">Payment Due Date</div>
                                             <div class="text-3xl font-bold mb-3">${data.payBy}</div>
                                             <div class="inline-flex items-center justify-center gap-2 font-bold text-sm self-center"><span class="text-lg">‚è∞</span> Immediate Action Required</div>
                                         </div>
                                     </div>
                                     <div class="space-y-2">
                                         ${infoTile('summary', 'üìÑ', 'Understanding Your Notice', 'What this notice means')}
                                         ${infoTile('why', '‚ùì', 'Why did I receive this?', 'Details from the IRS')}
                                         ${infoTile('breakdown', 'üí≤', 'Amount Breakdown', 'Itemized charges')}
                                         ${infoTile('fix', '‚úîÔ∏è', 'How should I fix this?', 'Next steps and options')}
                                         ${infoTile('payment', 'üí≥', 'Payment Options', 'Ways to pay your balance')}
                                     </div>
                                     <div id="active-section-container" class="mt-8">${renderActiveSummarySectionContent()}</div>
                                     <div class="text-center mt-8 pt-6 border-t border-slate-200">
                                         <div class="flex justify-center gap-4 mb-4">
                                             <button class="email-btn font-semibold py-2 px-5 rounded-lg transition-colors text-white" style="background-color: #ff6b00;">Email to Taxpayer</button>
                                             <button class="irs-response-btn font-semibold py-2 px-5 rounded-lg transition-colors text-white" style="background-color: #ff6b00;">Draft IRS Response</button>
                                         </div>
                                         <button class="analyze-another-btn font-bold py-3 px-8 rounded-lg transition-colors text-white" style="background-color: #ff6b00;">Analyze Another Notice</button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                `;
            };
            
            // --- LOGIC & EVENT HANDLERS ---
            const setState = (newState) => {
                state = { ...state, ...newState };
                renderView();
            };

            const handleLogin = (formData) => {
                if (formData.email && formData.password) {
                    setState({ view: 'dashboard', user: { id: Date.now(), firstName: "Alex", lastName: "Doe", email: formData.email, ...formData }, error: '' });
                } else {
                    setState({ error: "Invalid credentials" });
                }
            };
            
            const handleRegister = (formData) => {
                if (formData.password !== formData.confirmPassword) {
                    setState({ error: "Passwords do not match." });
                    return;
                }
                setState({ view: 'dashboard', user: { id: Date.now(), ...formData }, error: '' });
            };

            const handleFileUpload = (file) => {
                if (!file || file.type !== "application/pdf") {
                    showToast('Please upload a valid PDF file.', 'error');
                    return;
                }
                setState({ view: 'analyzing' });
                setTimeout(() => {
                    const fileName = file.name.toLowerCase();
                    let detectedData = null;
                    if (fileName.includes('cp23')) detectedData = cp23MockData;
                    else if (fileName.includes('cp503')) detectedData = cp503cMockData;

                    if (detectedData) {
                        const newHistoryItem = { ...detectedData, id: Date.now() };
                        const newHistory = [newHistoryItem, ...state.history].slice(0, 10);
                        setState({ view: 'summary', summaryData: detectedData, history: newHistory });
                    } else {
                        setState({ view: 'dashboard' });
                        showToast('Could not identify notice type (CP23 or CP503C).', 'error');
                    }
                }, 2000);
            };

            // --- ATTACH ALL EVENT LISTENERS ---
            function attachEventListeners() {
                const form = document.getElementById('auth-form');
                if (form) {
                    form.addEventListener('submit', e => {
                        e.preventDefault();
                        const formData = Object.fromEntries(new FormData(e.target).entries());
                        state.view === 'login' ? handleLogin(formData) : handleRegister(formData);
                    });
                }

                document.querySelector('.switch-view-btn')?.addEventListener('click', () => {
                    setState({ view: state.view === 'login' ? 'register' : 'login', error: '', isPasswordVisible: false });
                });

                document.querySelector('.logout-btn')?.addEventListener('click', () => setState({ user: null, view: 'login' }));
                
                document.querySelector('.profile-btn')?.addEventListener('click', () => {
                    showModal('My Profile', `<div class="space-y-2 text-black"><p><strong>Full Name:</strong> ${state.user?.firstName} ${state.user?.lastName}</p><p><strong>Email:</strong> ${state.user?.email}</p></div>`);
                });

                document.querySelector('.password-toggle')?.addEventListener('click', () => setState({ isPasswordVisible: !state.isPasswordVisible }));
                
                const passwordInput = document.querySelector('input[name="password"]');
                if (passwordInput && state.view === 'register') {
                    passwordInput.addEventListener('input', e => {
                        document.getElementById('password-strength-meter-container').innerHTML = renderPasswordStrengthMeter(e.target.value);
                    });
                }

                const countryCodeBtn = document.getElementById('country-code-btn');
                if (countryCodeBtn) {
                    countryCodeBtn.addEventListener('click', () => setState({ isCountryDropdownOpen: !state.isCountryDropdownOpen }));
                    document.getElementById('country-search').addEventListener('input', e => setState({ countrySearch: e.target.value }));
                    document.querySelectorAll('.country-item').forEach(item => {
                        item.addEventListener('click', e => setState({ countryCode: e.target.dataset.code, isCountryDropdownOpen: false, countrySearch: '' }));
                    });
                }

                const uploadArea = document.querySelector('.upload-area');
                if (uploadArea) {
                    const fileInput = document.querySelector('.file-input');
                    document.querySelector('.select-file-btn').addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
                    });
                    ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.add('border-orange-500', 'bg-orange-50')));
                    ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('border-orange-500', 'bg-orange-50')));
                    uploadArea.addEventListener('drop', e => handleFileUpload(e.dataTransfer.files[0]));
                }
                
                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', e => {
                        const id = parseInt(e.currentTarget.dataset.id, 10);
                        const historyItem = state.history.find(h => h.id === id);
                        if (historyItem) setState({ summaryData: historyItem, view: 'summary' });
                    });
                });

                document.querySelectorAll('.info-tile').forEach(tile => {
                    tile.addEventListener('click', e => {
                        const sectionId = e.currentTarget.dataset.sectionId;
                        setState({ activeSummarySection: state.activeSummarySection === sectionId ? null : sectionId });
                    });
                });

                document.querySelector('.close-section-btn')?.addEventListener('click', () => setState({ activeSummarySection: null }));
                document.querySelector('.analyze-another-btn')?.addEventListener('click', () => setState({ view: 'dashboard' }));
                document.querySelector('.email-btn')?.addEventListener('click', () => showModal('Email to Taxpayer', `<pre class="bg-slate-100 p-4 rounded-lg text-sm text-black whitespace-pre-wrap font-sans">${state.summaryData.emailTemplate}</pre><button class="copy-btn mt-4 text-white font-semibold py-2 px-5 rounded-lg" style="background-color: #ff6b00;">Copy to Clipboard</button>`));
                document.querySelector('.irs-response-btn')?.addEventListener('click', () => showModal('Draft IRS Response', `<pre class="bg-slate-100 p-4 rounded-lg text-sm text-black whitespace-pre-wrap font-sans">${state.summaryData.irsResponseTemplate}</pre><button class="copy-btn mt-4 text-white font-semibold py-2 px-5 rounded-lg" style="background-color: #ff6b00;">Copy to Clipboard</button>`));
                document.querySelector('.salt-link')?.addEventListener('click', () => showModal('What Is The SALT Deduction Limit?', `<div class="space-y-4 text-slate-700"><p>Since 2018, there's a <strong>$10,000 yearly limit</strong> on how much you can deduct for state and local taxes. You claimed $15,000, but the maximum allowed is $10,000.</p></div>`));
                modalContainer.addEventListener('click', e => {
                   if (e.target.closest('.copy-btn')) copyToClipboard(e.target.previousElementSibling.textContent);
                });
            }

            // --- INITIAL RENDER ---
            renderView();
        });
    </script>
</body>
</html>
