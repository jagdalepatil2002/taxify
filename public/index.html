<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Notice Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles and Animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa !important;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        @keyframes scale-in {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .animate-scale-in {
            animation: scale-in 0.3s ease-out forwards;
        }
        /* Custom scrollbar for dropdown */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main application container -->
    <div id="app-root"></div>

    <!-- Toast container -->
    <div id="toast-container"></div>

    <!-- Modal container -->
    <div id="modal-container"></div>

    <script>
        // --- Hardcoded Data Definitions ---

        // Data for CP23 Notice
        const cp23MockData = {
            noticeType: 'CP23', taxYear: '2018', noticeFor: 'JAMES Q. SPARROW', address: '22 BOULDER STREET HANSON, CT 00000-7253', ssn: 'NNN-NN-NNNN', amountDue: '$425.73', payBy: 'February 20, 2019',
            summary: { title: 'Quick Overview of the Notice', overview: "The IRS has made adjustments to your 2018 tax return (Form 1040) that resulted in an additional tax liability. The changes were made due to exceeding the maximum allowable limit for state and local tax (SALT) deductions on your itemized deductions.", keyPoints: ["This is a CP23 notice regarding changes made by the IRS to your 2018 tax return.", "Action Required: You have until February 20, 2019, to either pay the amount due ($425.73) or contact the IRS if you disagree with the adjustment."] },
            why: [{ title: "Notice Type: CP23", text: "This is a CP23 notice regarding changes made by the IRS to your 2018 tax return. The IRS indicates your State and Local Tax (SALT) deduction exceeded the $10,000 annual limit imposed by current tax law." }, { title: "What Is The SALT Deduction Limit?", text: "Click to learn more about the SALT Deduction Limit.", isClickable: true, id: 'salt' }, { title: "Tax Year 2018", text: "This notice pertains to adjustments made to your 2018 tax return filing." }, { title: "What Happens Next?", text: "The IRS has automatically corrected your tax return by reducing your itemized deductions to comply with federal tax law limits. This correction increased your taxable income and resulted in additional tax, penalty, and interest charges. If you believe there's an error, gather your supporting tax documents and contact the IRS within 30 days to dispute the adjustment." }],
            breakdown: { items: [{ item: "Tax you owed", amount: "$1,828.00", detail: "Adjusted tax after SALT correction" }, { item: "Payments you made", amount: "-$1,624.00", detail: "Total payments and credits recorded by the IRS" }, { item: "Failure-to-file penalty", amount: "$135.00", detail: "Penalty for filing the return after the due date" }, { item: "Failure-to-pay penalty", amount: "$65.00", detail: "Penalty for not paying the tax owed by the due date" }, { item: "Interest charges", amount: "$21.73", detail: "Interest accrued on the unpaid balance" }, { item: "Total Amount Due", amount: "$425.73", detail: "Final balance to be paid", isTotal: true }], notes: ["Your original return was adjusted because your State and Local Tax (SALT) deduction exceeded the $10,000 limit. The IRS corrected this, which increased your taxable income and the total tax you owed."] },
            fix: { steps: [{ title: "Step 1: Check Your SALT Deductions", points: ["Add up your state and local taxes from 2018: This includes state income tax, property tax, and local taxes.", "Confirm if the total is over $10,000. If so, the IRS adjustment is likely correct.", "Review Schedule A of your 2018 tax return to see the amount you originally claimed."] }, { title: "If The IRS Is Right:", points: ["Pay the amount due: $425.73 by February 20, 2019.", "Use the payment slip that came with the notice or pay online at irs.gov/payments.", "Remember the $10,000 SALT limit for future tax filings."] }, { title: "If You Think The IRS Is Wrong:", points: ["Call the number on the notice (800-829-1040) within 60 days.", "Have these ready: Your tax return, state tax forms, and property tax bills.", "Explain why you believe the adjustment is incorrect (e.g., the IRS miscalculated your total state and local taxes)."] }] },
            paymentOptions: [{ icon: 'üåê', title: "Online Payment", details: ["Website: www.irs.gov/payments", "Amount Due: $425.73", "Options: Bank transfer, debit/credit card"] }, { icon: 'üìÖ', title: "Payment Plan Setup", details: ["Online: www.irs.gov/paymentplan", "Note: You may qualify for a payment plan if you cannot pay the full amount at once."] }],
            help: { irsPhone: "800-829-1040", tas: "The Taxpayer Advocate Service (TAS) is an independent organization within the IRS that helps taxpayers and protects taxpayer rights. You can reach them at www.taxpayeradvocate.irs.gov or 1-877-777-4778." },
            modalContent: { salt: { title: "SALT Deduction Limit Explained", content: [{ heading: "What is the limit?", text: "Since 2018, there's a $10,000 yearly limit on how much you can deduct for state and local taxes ($5,000 if married filing separately)." }, { heading: "What counts as State and Local Taxes?", text: "This includes property taxes on your home, plus either your state and local income taxes OR your state and local sales taxes (you can't deduct both)." }, { heading: "Why was my return changed?", text: "The IRS computer automatically checks all tax returns for this limit. If it finds a claimed deduction over $10,000, it automatically reduces the deduction to the legal maximum and recalculates the tax owed." }] } },
            emailTemplate: `Subject: Important: Action Required - IRS Notice CP23 for Tax Year 2018\n\nDear JAMES Q. SPARROW,\n\nThis is a follow-up regarding the IRS Notice CP23 for tax year 2018. The notice indicates a balance due of $425.73, which must be paid by February 20, 2019.\n\nThe IRS made adjustments to your return because the State and Local Tax (SALT) deduction claimed exceeded the $10,000 limit.\n\nPlease review the notice and your tax documents. If you agree with the changes, please submit the payment by the due date. If you disagree, you must contact the IRS within 60 days.\n\nBest regards,\n[Your Name]`,
            irsResponseTemplate: `Internal Revenue Service\n[IRS Processing Center Address from Notice]\n\nRe: Notice CP23 - Response\nTaxpayer: JAMES Q. SPARROW\nSSN: XXX-XX-[Last 4 digits]\nTax Year: 2018\nNotice Date: January 30, 2019\n\nDear IRS Representative,\n\nI am writing in response to the CP23 notice dated January 30, 2019, regarding the State and Local Tax (SALT) deduction.\n\n[SELECT ONE OPTION]\n\nOption 1: I agree with the changes and have submitted payment for the full amount of $425.73.\n\nOption 2: I disagree with the changes. Please see the enclosed documents which show [Explain why you believe your SALT deduction was correct].\n\nSincerely,\n[Signature]\nJAMES Q. SPARROW`
        };

        // Data for CP503C Notice
        const cp503cMockData = {
            noticeType: 'CP503C', taxYear: '2019', noticeFor: 'MICHAEL & JENNIFER L. RODRIGUEZ', address: '789 OAK STREET\nPHOENIX, AZ 85001-5678', ssn: 'NNN-NN-NNNN', amountDue: '$9,533.53', payBy: 'March 15, 2025',
            summary: { title: 'IRS Notice CP503 is a second reminder from the IRS', overview: "The IRS sent Notice CP503 because they haven't received payment or a response to earlier communications about your unpaid tax balance. This is the second reminder and encourages you to act promptly to avoid further penalties or enforced collection efforts, such as a federal tax lien.", keyPoints: ["This is your second notice regarding unpaid taxes", "Previous communications were sent but no response received", "Immediate action required to prevent escalation", "Risk of federal tax lien if unresolved"] },
            why: [{ title: "Notice Type: CP503", text: "This is your second reminder about unpaid taxes. The IRS has already sent you a first notice (CP501) which was not resolved." }, { title: "Tax Year: 2016", text: "The unpaid balance relates to your 2016 tax return (Form 1040A) filed for the tax year ending December 31, 2016." }, { title: "üö© What Happens Next?", text: "If this notice is not addressed, the IRS may take collection actions including liens, levies, or wage garnishment." }],
            breakdown: { items: [{ item: "Original amount owed", amount: "$9,444.07", detail: "Tax liability from 2016 Form 1040A" }, { item: "Failure-to-pay penalty", amount: "$34.98", detail: "Internal Revenue Code Section 6651" }, { item: "Interest charges", amount: "$54.48", detail: "Internal Revenue Code Section 6601" }, { item: "Total Amount Due", amount: "$9,533.53", detail: "As of notice date", isTotal: true }], notes: [{ title: "Legal Framework", text: "Internal Revenue Code Section 6601: Authorizes interest on unpaid taxes from the due date until paid in full." }, { title: "Penalty Authority", text: "Internal Revenue Code Sections 6651 & 6654: Establish failure-to-pay penalties for late tax payments." }] },
            fix: { steps: [{ title: "Step 1: Review Your Records First", points: ["Verify all payments made: Check bank statements, canceled checks, and payment confirmations", "Review payment timing: Ensure payments were processed by the IRS before the due date",] }, { title: "Step 2: If You Agree with the Amount", points: ["Pay immediately to stop interest and penalties from accruing", "Set up installment agreement if you cannot pay in full",] }, { title: "If You Disagree with the Amount", points: ["Contact IRS immediately - don't wait for the deadline", "Gather documentation (returns, payment records, correspondence)",] }] },
            paymentOptions: [{ icon: 'üåê', title: "Online Payment", details: ["Website: www.irs.gov/payments", "Amount Due: $9,533.53", "Options: Bank transfer, debit/credit card", "Status: ‚úÖ Available 24/7"] }, { icon: 'üìû', title: "Phone Payment", details: ["Number: 1-888-PAY-1040", "Hours: 24/7 automated system", "Status: ‚úÖ Immediate processing"] }, { icon: 'üìÆ', title: "Mail Payment", details: ["Address: Internal Revenue Service P.O. Box 1218 Charlotte, NC 28201-1218", "Include: Payment voucher from notice", "Status: ‚ö†Ô∏è May be too slow for this notice"] }, { icon: 'üìÖ', title: "Payment Plan Setup", details: ["Online: www.irs.gov/paymentplan", "Setup Fee: $31 online, $149 phone/mail", "Status: ‚úÖ Prevents collection actions"] },],
            help: { irsPhone: "1-800-829-0922", tas: "The Taxpayer Advocate Service (TAS) can help protect your taxpayer rights. Visit www.taxpayeradvocate.irs.gov or call 1-877-777-4778." },
            emailTemplate: `Subject: Important: Action Required - Second IRS notice balance due to be paid\n\nDear [Taxpayer Name],\n\nYou have received the: CP503 (Second Notice) for Tax Year: 2016 indicating a balance due for $9,533.53.\n\nThis is the second reminder, and it's crucial that you take action promptly to avoid further penalties, interest charges, or enforced collection efforts such as a federal tax lien.\n\nIf you have any questions or need assistance, please don't hesitate to contact me.\n\nBest regards,\n[Your Name]`,
            irsResponseTemplate: `Internal Revenue Service\n[IRS Processing Center Address from Notice]\n\nRe: Notice CP503 - Second Notice Response\nTaxpayer: [Taxpayer Name]\nSSN: XXX-XX-[Last 4 digits]\nTax Year: 2016\nNotice Date: [Notice Date]\n\nDear IRS Representative,\n\nI am writing in response to the CP503 notice dated [Notice Date] regarding an unpaid tax balance of $9,533.53 for tax year 2016.\n\n[INSTRUCTIONS: Please select and keep only ONE of the options below and delete the others.]\n\n---\nOption 1: Payment is enclosed.\nEnclosed is my check for the full amount of $9,533.53. Please apply it to my outstanding balance for tax year 2016.\n\n---\nOption 2: I have already paid this amount.\nI believe there is an error, as I have already submitted payment for this balance. Payment was sent on [Date of Payment] via [Payment Method, e.g., check, online payment]. A copy of my payment confirmation is enclosed. Please investigate and update my account status.\n\n---\nOption 3: I cannot pay the full amount now and request a payment plan.\nI am unable to pay the full amount at this time. I would like to request an installment agreement. I have visited irs.gov/paymentplan to review my options and have enclosed Form 9465, Installment Agreement Request.\n\n---\nOption 4: I disagree with the amount you say I owe.\nI disagree with the amount shown on the notice. I believe the correct amount is [Your Calculated Amount] because [Briefly explain why you disagree, e.g., a payment was not credited, a deduction was disallowed in error]. Please find my supporting documentation enclosed for your review.\n\nSincerely,\n[Signature]\n[Printed Name]`
        };

        const countryCodes = [
            { "name": "United States", "dial_code": "+1", "code": "US" }, { "name": "United Kingdom", "dial_code": "+44", "code": "GB" }, { "name": "Canada", "dial_code": "+1", "code": "CA" }, { "name": "Australia", "dial_code": "+61", "code": "AU" }, { "name": "Germany", "dial_code": "+49", "code": "DE" }
        ];

        let allowedUsers = [
            { email: 'user@gmail.com', password: 'pass123', firstName: 'user', lastName: 'test' }, { email: 'john.doe@example.com', password: 'securepassword', firstName: 'John', lastName: 'Doe' }, { email: 'jane.doe@example.com', password: 'anotherpassword', firstName: 'Jane', lastName: 'Doe' }
        ];

        // --- API Service (Mocked) ---
        const api = {
            async register(payload) {
                console.log("Registering (mock):", payload);
                await new Promise(resolve => setTimeout(resolve, 500));
                if (allowedUsers.length >= 5) return { success: false, message: "Maximum number of users (5) reached." };
                if (allowedUsers.some(user => user.email === payload.email)) return { success: false, message: "Email is already registered." };
                const newUser = { email: payload.email, password: payload.password, firstName: payload.firstName, lastName: payload.lastName, dob: payload.dob, mobileNumber: payload.mobileNumber };
                allowedUsers.push(newUser);
                console.log("Updated allowedUsers list:", allowedUsers);
                return { success: true, user: { id: Date.now(), ...newUser } };
            },
            async login(payload) {
                console.log("Logging in (mock):", payload);
                await new Promise(resolve => setTimeout(resolve, 500));
                // Modified for demo to always succeed
                return { success: true, user: { id: Date.now(), firstName: "Demo", lastName: "User", email: payload.email } };
            },
        };

        // --- SVG Icons ---
        const UploadCloudIcon = (isDragging) => `<svg class="mx-auto h-16 w-16 mb-4 transition-colors ${isDragging ? 'text-orange-600' : 'text-slate-400'}" style="color: ${isDragging ? '#ff6b00' : ''}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></svg>`;
        const EyeIcon = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>`;
        const EyeOffIcon = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></svg>`;

        // --- Application State ---
        let state = {
            view: 'login',
            user: null,
            error: '',
            summaryData: null,
            history: [],
            isPasswordVisible: false,
            isDropdownOpen: false,
            countrySearch: '',
            activeAccordion: null,
            formData: {
                firstName: '', lastName: '', email: '', password: '', confirmPassword: '',
                dob: '', mobileNumber: '', countryCode: '+1'
            }
        };

        // --- DOM Elements ---
        const appRoot = document.getElementById('app-root');
        const toastContainer = document.getElementById('toast-container');
        const modalContainer = document.getElementById('modal-container');

        // --- UI Component Functions ---

        function showToast(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const toastId = `toast-${Date.now()}`;
            const toastHTML = `
                <div id="${toastId}" class="fixed bottom-5 right-5 ${bgColor} text-white py-3 px-6 rounded-lg shadow-lg animate-fade-in z-50">
                    ${message}
                </div>
            `;
            toastContainer.innerHTML = toastHTML;
            setTimeout(() => {
                const toastEl = document.getElementById(toastId);
                if (toastEl) toastEl.remove();
            }, 3000);
        }

        function showModal(title, contentHTML, onClose) {
            const modalHTML = `
                <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-transform duration-300 scale-95 animate-scale-in">
                        <header class="flex items-center justify-between p-4 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-black">${title}</h3>
                            <button id="modal-close-btn" class="text-slate-400 hover:text-black transition-colors rounded-full p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </header>
                        <main class="p-6 overflow-y-auto custom-scrollbar">${contentHTML}</main>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            document.getElementById('modal-backdrop').addEventListener('click', hideModal);
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            modalContainer.querySelector('.bg-white').addEventListener('click', e => e.stopPropagation());
        }

        function hideModal() {
            modalContainer.innerHTML = '';
        }

        function renderPasswordStrengthMeter(password) {
            let score = 0;
            if (!password) score = 0;
            else {
                if (password.length >= 8) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/[0-9]/.test(password)) score++;
                if (/[^A-Za-z0-9]/.test(password)) score++;
            }
            const color = ['bg-slate-200', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'][score];
            const label = ['Too short', 'Weak', 'Fair', 'Good', 'Strong'][score];

            return `
                <div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all ${color}" style="width: ${(score / 4) * 100}%"></div>
                    </div>
                    <p class="text-xs text-right text-slate-500 mt-1">${label}</p>
                </div>
            `;
        }

        // --- Screen Rendering Functions ---

        function renderAuthScreen(isLogin) {
            const { formData } = state;
            const filteredCountries = countryCodes.filter(c =>
                c.name.toLowerCase().includes(state.countrySearch.toLowerCase()) ||
                c.dial_code.includes(state.countrySearch)
            );

            return `
                <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-slate-100 max-w-md w-full animate-fade-in">
                    <h2 class="text-3xl font-bold text-center text-black mb-2">${isLogin ? "Welcome Back" : "Create Account"}</h2>
                    <p class="text-center text-slate-500 mb-8">${isLogin ? "Please enter your details to sign in." : "Simplify your tax notices today."}</p>
                    <form id="auth-form" class="space-y-4">
                        ${!isLogin ? `
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" name="firstName" placeholder="First Name" value="${formData.firstName}" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                                <input type="text" name="lastName" placeholder="Last Name" value="${formData.lastName}" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                            </div>
                            <input type="text" name="dob" placeholder="Date of Birth" onfocus="(this.type='date')" onblur="(this.type='text')" value="${formData.dob}" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                            <div class="flex">
                                <div class="relative w-1/3" id="country-dropdown-container">
                                    <button type="button" id="country-code-btn" class="w-full h-full bg-slate-50 border border-r-0 border-slate-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-orange-500 px-3 py-3 text-slate-700 flex justify-between items-center">
                                        <span>${formData.countryCode}</span>
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                    </button>
                                    ${state.isDropdownOpen ? `
                                        <div class="absolute z-10 mt-1 w-72 bg-white border border-slate-300 rounded-md shadow-lg">
                                            <input type="text" id="country-search" placeholder="Search..." value="${state.countrySearch}" class="w-full px-3 py-2 border-b border-slate-200 focus:outline-none"/>
                                            <ul class="max-h-48 overflow-auto custom-scrollbar">
                                                ${filteredCountries.map(country => `
                                                    <li data-code="${country.dial_code}" class="px-4 py-2 text-slate-700 hover:bg-orange-100 cursor-pointer country-option">
                                                        ${country.name} (${country.dial_code})
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                                <input type="tel" name="mobileNumber" placeholder="Mobile Number" value="${formData.mobileNumber}" class="w-2/3 px-4 py-3 bg-white border border-slate-300 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                            </div>
                        ` : ''}
                        <input type="email" name="email" placeholder="Email Address" value="${formData.email}" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                        <div class="relative">
                            <input type="${state.isPasswordVisible ? "text" : "password"}" id="password-input" name="password" placeholder="Password" value="${formData.password}" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                            <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500">
                                ${state.isPasswordVisible ? EyeOffIcon : EyeIcon}
                            </button>
                        </div>
                        ${!isLogin ? `
                            <div class="relative">
                                <input type="${state.isPasswordVisible ? "text" : "password"}" name="confirmPassword" placeholder="Confirm Password" value="${formData.confirmPassword}" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required />
                            </div>
                            <div id="password-strength-meter">
                                ${renderPasswordStrengthMeter(formData.password)}
                            </div>
                        ` : ''}
                        ${state.error ? `<p class="text-red-500 text-sm text-center">${state.error}</p>` : ''}
                        <button type="submit" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition-colors shadow-md shadow-orange-200 !mt-6" style="background-color: #ff6b00;">
                            ${isLogin ? "Sign In" : "Create Account"}
                        </button>
                    </form>
                    <p class="text-center text-sm text-slate-600 mt-6">
                        ${isLogin ? "No account?" : "Already have an account?"}
                        <button id="switch-view-btn" class="font-semibold text-orange-500 hover:underline ml-1" style="color: #ff6b00">${isLogin ? "Sign up" : "Sign in"}</button>
                    </p>
                </div>
            `;
        }
        
        function renderDashboardScreen() {
            const { user, history } = state;
            return `
                <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-slate-100 max-w-4xl w-full animate-fade-in">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-black">Dashboard</h1>
                            <p class="text-slate-500">Welcome back, ${user?.firstName} ${user?.lastName}!</p>
                        </div>
                        <div class="space-x-4">
                            <button id="profile-btn" class="text-slate-500 hover:text-black font-semibold transition-colors">Profile</button>
                            <button id="logout-btn" class="text-slate-500 hover:text-black font-semibold transition-colors">Sign Out</button>
                        </div>
                    </header>
                    <main class="grid lg:grid-cols-2 gap-8">
                        <section>
                            <h2 class="text-xl font-bold text-black mb-4">New Analysis</h2>
                            ${renderUploadScreen()}
                        </section>
                        <section class="flex flex-col">
                            <h2 class="text-xl font-bold text-black mb-4">Analysis History</h2>
                            <div class="bg-white p-6 rounded-xl border-2 border-slate-200 flex-grow">
                                ${history.length > 0 ? `
                                    <ul class="space-y-3">
                                        ${history.map(item => `
                                            <li data-id="${item.id}" class="history-item flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:bg-orange-100 cursor-pointer transition-colors">
                                                <div>
                                                    <p class="font-semibold text-black">${item.noticeFor}</p>
                                                    <p class="text-sm text-slate-500">Notice: ${item.noticeType}</p>
                                                </div>
                                                <span class="text-sm font-semibold" style="color: #ff6b00;">
                                                    ${item.amountDue}
                                                </span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                ` : `
                                    <div class="flex items-center justify-center h-full">
                                        <p class="text-center text-slate-500">No past analyses found. Upload a PDF to begin.</p>
                                    </div>
                                `}
                            </div>
                        </section>
                    </main>
                </div>
            `;
        }

        function renderUploadScreen(isDragging = false) {
            return `
                <div id="drop-zone" class="border-2 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all duration-300 ${isDragging ? 'border-orange-500 bg-orange-50' : 'border-slate-300 bg-white'}">
                    ${UploadCloudIcon(isDragging)}
                    <p class="mt-4 text-lg text-black font-semibold">Drop your PDF file here</p>
                    <p class="text-sm text-slate-500 mt-1">or</p>
                    <button type="button" id="select-file-btn" class="mt-4 bg-orange-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-orange-600 transition-colors" style="background-color: #ff6b00;">
                        Select a File
                    </button>
                    <input type="file" id="file-input" class="hidden" accept=".pdf" />
                </div>
            `;
        }

        function getAccordionContent(sectionId) {
            const data = state.summaryData;
            if (!data) return '';

            switch (sectionId) {
                case 'summary':
                    return `<div>
                        <p class="text-slate-600 mb-4">${data.summary?.overview}</p>
                        <h4 class="font-bold text-black mb-2">Key Points:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-600">
                            ${data.summary?.keyPoints?.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>`;
                case 'why':
                    return `<div>
                        ${data.why?.map(item => `<div class="mb-4 last:mb-0">
                            <h4 class="font-bold text-black">${item.title}</h4>
                            ${item.isClickable ? `<p class="text-slate-600 underline cursor-pointer hover:text-orange-500" onclick="handleSaltModal()">${item.text}</p>` : `<p class="text-slate-600">${item.text}</p>`}
                        </div>`).join('')}
                    </div>`;
                case 'breakdown':
                    return `<div>
                        <table class="w-full text-sm mb-4 text-black">
                            <tbody>
                                ${data.breakdown?.items?.map(item => `<tr class="border-b ${item.isTotal ? 'font-bold' : ''}" style="border-color: #F1F5F9">
                                    <td class="p-2">${item.item}</td>
                                    <td class="p-2 text-right font-mono ${item.isTotal ? 'text-orange-500' : ''}">${item.amount}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                        <div class="space-y-4">
                            ${data.breakdown?.notes?.map(note => `<div>
                                <h5 class="font-bold text-black">${note.title || ''}</h5>
                                <p class="text-sm text-slate-600">${note.text || note}</p>
                            </div>`).join('')}
                        </div>
                    </div>`;
                case 'fix':
                    return `<div>
                        ${data.fix?.steps?.map(item => `<div class="mb-4 last:mb-0">
                            <h4 class="font-bold text-black">${item.title}</h4>
                            <ul class="list-disc list-inside text-slate-600">
                                ${item.points.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>`).join('')}
                    </div>`;
                case 'payment':
                   return `<div class="grid md:grid-cols-2 gap-4">
                        ${data.paymentOptions?.map(item => `<div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h4 class="font-bold text-black flex items-center gap-2"><span class="text-xl">${item.icon}</span>${item.title}</h4>
                            <ul class="text-sm text-slate-600 mt-2 space-y-1">
                                ${item.details.map(d => `<li>${d}</li>`).join('')}
                            </ul>
                        </div>`).join('')}
                    </div>`;
                default:
                    return '';
            }
        }

        function renderSummaryScreen() {
            const data = state.summaryData;
            const accentColor = '#ff6b00';
            if (!data) return `
                <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-slate-100 max-w-lg w-full animate-fade-in text-center">
                    <h2 class="text-2xl font-bold text-black mb-4">Data Not Available</h2>
                    <p class="text-slate-600 mb-6">There was an issue loading the summary data.</p>
                    <button id="reset-app-btn" class="bg-slate-700 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-black transition-colors">
                        Back to Dashboard
                    </button>
                </div>
            `;

            const infoTiles = [
                { id: 'summary', icon: 'üìÑ', title: 'Understanding Your Notice', preview: 'What this notice means' },
                { id: 'why', icon: '‚ùì', title: 'Why did I receive this?', preview: 'Details from the IRS' },
                { id: 'breakdown', icon: 'üí≤', title: 'Amount Breakdown', preview: 'Itemized charges' },
                { id: 'fix', icon: '‚úîÔ∏è', title: 'How should I fix this?', preview: 'Next steps and options' },
                { id: 'payment', icon: 'üí≥', title: 'Payment Options', preview: 'Ways to pay your balance' },
            ];

            return `
                <div class="w-full max-w-6xl mx-auto animate-fade-in my-8">
                    <div class="header text-center mb-8">
                        <h1 class="text-black text-4xl font-bold mb-2">IRS Notice Analysis</h1>
                        <p class="text-slate-500 text-lg">Professional breakdown and action plan for your tax notice</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        <div class="notice-header text-white p-8 text-center relative" style="background-color: ${accentColor}">
                            <div class="notice-title text-2xl font-bold mb-4 relative z-10">Summary of Your ${data.taxYear} IRS Notice ${data.noticeType}</div>
                            <div class="notice-type bg-white bg-opacity-20 px-4 py-2 rounded-full inline-block font-semibold relative z-10">Analysis Complete</div>
                        </div>
                        <div class="notice-body p-8">
                            <div class="client-info bg-slate-50 rounded-xl p-6 mb-8 border-l-4" style="border-color: ${accentColor}">
                                <div class="client-name text-xl font-bold text-black mb-1">${data.noticeFor}</div>
                                <div class="client-address text-slate-600 mb-4 whitespace-pre-line">${data.address}</div>
                                <div class="ssn-info text-sm text-slate-500">Social Security Number: ${data.ssn}</div>
                                <div class="ssn-info text-sm mt-2 font-bold" style="color: ${accentColor}">Tax Year: ${data.taxYear}</div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div class="p-6 rounded-xl text-white text-center shadow-lg flex flex-col justify-center" style="background: linear-gradient(135deg, #ff6b00 0%, #ff8533 100%)">
                                    <div class="text-sm opacity-90 mb-2">Total Amount Due</div>
                                    <div class="text-4xl font-bold mb-3">${data.amountDue}</div>
                                </div>
                                <div class="p-6 rounded-xl text-black text-center shadow-lg flex flex-col justify-center" style="background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%)">
                                    <div class="text-sm opacity-80 mb-2">Payment Due Date</div>
                                    <div class="text-3xl font-bold mb-3">${data.payBy}</div>
                                    <div class="inline-flex items-center justify-center gap-2 font-bold text-sm self-center">
                                        <span class="text-lg">‚è∞</span> Immediate Action Required
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                ${infoTiles.map(tile => `
                                    <div data-id="${tile.id}" class="info-tile bg-white rounded-lg border border-slate-200 hover:shadow-md transition-all duration-300 overflow-hidden">
                                        <div class="info-tile-header p-4 cursor-pointer flex items-center gap-4">
                                            <div class="text-2xl" style="color: ${accentColor}">${tile.icon}</div>
                                            <div class="flex-1">
                                                <p class="text-base font-semibold text-black">${tile.title}</p>
                                                <p class="text-slate-500 text-sm">${tile.preview}</p>
                                            </div>
                                            <button class="text-orange-500 text-xl font-bold transform transition-transform duration-300 ${state.activeAccordion === tile.id ? 'rotate-90' : ''}">‚ñ∂</button>
                                        </div>
                                        <div class="transition-all duration-500 ease-in-out ${state.activeAccordion === tile.id ? 'max-h-screen' : 'max-h-0'}">
                                            <div class="p-6 border-t border-slate-200 bg-slate-50">
                                                ${getAccordionContent(tile.id)}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="text-center mt-8 pt-6 border-t border-slate-200">
                                <div class="flex justify-center gap-4 mb-4">
                                    <button id="email-btn" class="font-semibold py-2 px-5 rounded-lg transition-colors bg-orange-500 text-white hover:bg-orange-600" style="background-color: ${accentColor}">Email to Taxpayer</button>
                                    <button id="irs-response-btn" class="font-semibold py-2 px-5 rounded-lg transition-colors bg-orange-500 text-white hover:bg-orange-600" style="background-color: ${accentColor}">Draft IRS Response</button>
                                </div>
                                <button id="reset-app-btn" class="font-bold py-3 px-8 rounded-lg transition-colors bg-orange-500 text-white hover:bg-orange-600" style="background-color: ${accentColor}">Analyze Another Notice</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoadingSpinner() {
            return `
                <div class="flex flex-col items-center justify-center space-y-4 text-center">
                    <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-orange-500" style="border-color: #ff6b00"></div>
                    <p class="text-black font-semibold text-lg">AI is analyzing your notice...</p>
                    <p class="text-slate-500">This may take a moment. Please don't close the window.</p>
                </div>
            `;
        }

        // --- Event Handlers & Logic ---

        function clearFormFields() {
            state.error = '';
            state.formData = {
                firstName: '', lastName: '', email: '', password: '', confirmPassword: '',
                dob: '', mobileNumber: '', countryCode: '+1'
            };
        }

        async function handleRegister(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            
            state.error = '';
            if (payload.password !== payload.confirmPassword) {
                state.error = "Passwords do not match.";
                renderView();
                return;
            }
            
            payload.mobileNumber = `${state.formData.countryCode}${payload.mobileNumber}`;
            const result = await api.register(payload);
            if (result.success) {
                state.user = result.user;
                state.view = 'dashboard';
            } else {
                state.error = result.message || "Registration failed.";
            }
            renderView();
        }

        async function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            
            state.error = '';
            const result = await api.login(payload);
            if (result.success) {
                state.user = result.user;
                state.view = 'dashboard';
            } else {
                state.error = result.message || "Login failed.";
            }
            renderView();
        }

        function handleLogout() {
            state.user = null;
            state.view = 'login';
            renderView();
        }
        
        function resetApp() {
            state.view = 'dashboard';
            state.summaryData = null;
            state.error = '';
            renderView();
        }

        function handleFileUpload(file) {
            if (!file || file.type !== "application/pdf") {
                showToast('Please upload a valid PDF file.', 'error');
                return;
            }

            state.view = 'analyzing';
            renderView();

            setTimeout(() => {
                const fileName = file.name.toLowerCase();
                let detectedData = null;

                if (fileName.includes('cp23')) detectedData = cp23MockData;
                else if (fileName.includes('cp503') || fileName.includes('cp503c')) detectedData = cp503cMockData;

                if (detectedData) {
                    const newHistoryItem = { ...detectedData, id: Date.now(), pdfFile: file };
                    state.history = [newHistoryItem, ...state.history].slice(0, 10);
                    state.summaryData = detectedData;
                    state.view = 'summary';
                } else {
                    state.view = 'dashboard';
                    showToast('Could not identify notice type (CP23 or CP503C) from filename.', 'error');
                }
                renderView();
            }, 2000);
        }

        function handleHistoryClick(itemId) {
            const item = state.history.find(h => h.id == itemId);
            if (item) {
                state.summaryData = item;
                state.view = 'summary';
                renderView();
            }
        }

        function switchView(newView) {
            clearFormFields();
            state.view = newView;
            renderView();
        }

        function handleAuthFormInput(e) {
            const { name, value } = e.target;
            state.formData[name] = value;
            if (name === 'password' && state.view === 'register') {
                const meter = document.getElementById('password-strength-meter');
                if (meter) meter.innerHTML = renderPasswordStrengthMeter(value);
            }
        }

        function togglePasswordVisibility() {
            state.isPasswordVisible = !state.isPasswordVisible;
            const passwordInput = document.getElementById('password-input');
            const toggleBtn = document.getElementById('toggle-password-btn');
            if (passwordInput && toggleBtn) {
                passwordInput.type = state.isPasswordVisible ? 'text' : 'password';
                toggleBtn.innerHTML = state.isPasswordVisible ? EyeOffIcon : EyeIcon;
            }
        }
        
        function handleCountryCodeChange(code) {
            state.formData.countryCode = code;
            state.isDropdownOpen = false;
            state.countrySearch = '';
            renderView();
        }
        
        function handleAccordionToggle(sectionId) {
            if (state.activeAccordion === sectionId) {
                state.activeAccordion = null;
            } else {
                state.activeAccordion = sectionId;
            }
            renderView();
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy.', 'error');
            }
            document.body.removeChild(textArea);
        }

        function handleSaltModal() {
            const title = "What Is The SALT Deduction Limit?";
            const content = `<div class="space-y-4 text-slate-700">
                <p>Since 2018, there's a <strong>$10,000 yearly limit</strong> on how much you can deduct for state and local taxes. You claimed $15,000, but the maximum allowed is $10,000.</p>
                <div>
                    <h4 class="font-bold text-black">What Counts As State and Local Taxes?</h4>
                    <ul class="list-disc list-inside mt-2">
                        <li>State income tax you paid</li>
                        <li>Property taxes on your home</li>
                        <li>Local city or county taxes</li>
                    </ul>
                    <p class="mt-2">All of these combined cannot exceed $10,000.</p>
                </div>
                <p>The IRS computer automatically checks all tax returns for this limit. When it found you claimed more than $10,000, it automatically reduced your deduction to the legal maximum.</p>
            </div>`;
            showModal(title, content);
        }

        // --- Main Render Function ---

        function renderView() {
            const { view } = state;
            let content = '';
            
            if (view === 'register') content = renderAuthScreen(false);
            else if (view === 'login') content = renderAuthScreen(true);
            else if (view === 'dashboard') content = renderDashboardScreen();
            else if (view === 'analyzing') content = renderLoadingSpinner();
            else if (view === 'summary') content = renderSummaryScreen();
            else content = renderAuthScreen(true);

            appRoot.innerHTML = content;
            attachEventListeners();
        }

        function attachEventListeners() {
            const { view } = state;

            if (view === 'login' || view === 'register') {
                document.getElementById('auth-form').addEventListener('submit', view === 'login' ? handleLogin : handleRegister);
                document.getElementById('auth-form').addEventListener('input', handleAuthFormInput);
                document.getElementById('switch-view-btn').addEventListener('click', () => switchView(view === 'login' ? 'register' : 'login'));
                document.getElementById('toggle-password-btn').addEventListener('click', togglePasswordVisibility);

                if (view === 'register') {
                    const countryBtn = document.getElementById('country-code-btn');
                    if (countryBtn) countryBtn.addEventListener('click', () => {
                        state.isDropdownOpen = !state.isDropdownOpen;
                        renderView();
                    });

                    document.querySelectorAll('.country-option').forEach(el => {
                        el.addEventListener('click', (e) => handleCountryCodeChange(e.currentTarget.dataset.code));
                    });
                    
                    const countrySearch = document.getElementById('country-search');
                    if(countrySearch) countrySearch.addEventListener('input', e => {
                        state.countrySearch = e.target.value;
                        renderView();
                    });
                    
                    document.addEventListener('click', (event) => {
                        const container = document.getElementById('country-dropdown-container');
                        if (container && !container.contains(event.target) && state.isDropdownOpen) {
                            state.isDropdownOpen = false;
                            renderView();
                        }
                    });
                }
            } else if (view === 'dashboard') {
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('profile-btn').addEventListener('click', () => {
                    const { user } = state;
                    const content = `<div class="space-y-2 text-black">
                        <p><strong>Full Name:</strong> ${user?.firstName} ${user?.lastName}</p>
                        <p><strong>Email:</strong> ${user?.email}</p>
                        <p><strong>Date of Birth:</strong> ${user?.dob || 'Not available'}</p>
                        <p><strong>Mobile Number:</strong> ${user?.mobileNumber || 'Not available'}</p>
                        <p class="text-sm text-slate-500 pt-4">Profile editing is not yet available. Full details are shown for the current session after registration.</p>
                    </div>`;
                    showModal('My Profile', content);
                });
                
                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', (e) => handleHistoryClick(e.currentTarget.dataset.id));
                });

                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');
                document.getElementById('select-file-btn').addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

                dropZone.addEventListener('dragenter', e => { e.preventDefault(); e.stopPropagation(); dropZone.className = 'border-2 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all duration-300 border-orange-500 bg-orange-50'; });
                dropZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dropZone.className = 'border-2 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all duration-300 border-slate-300 bg-white'; });
                dropZone.addEventListener('dragover', e => e.preventDefault());
                dropZone.addEventListener('drop', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.className = 'border-2 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all duration-300 border-slate-300 bg-white';
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        handleFileUpload(e.dataTransfer.files[0]);
                        e.dataTransfer.clearData();
                    }
                });

            } else if (view === 'summary') {
                document.getElementById('reset-app-btn').addEventListener('click', resetApp);
                document.querySelectorAll('.info-tile-header').forEach(tile => {
                    tile.addEventListener('click', (e) => handleAccordionToggle(e.currentTarget.parentElement.dataset.id));
                });
                document.getElementById('email-btn').addEventListener('click', () => {
                    const content = `<pre class="bg-slate-100 p-4 rounded-lg text-sm text-black whitespace-pre-wrap font-sans">${state.summaryData.emailTemplate}</pre>
                    <button onclick="copyToClipboard(state.summaryData.emailTemplate)" class="mt-4 bg-orange-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-orange-600" style="background-color: #ff6b00">Copy to Clipboard</button>`;
                    showModal('Email to Taxpayer', content);
                });
                document.getElementById('irs-response-btn').addEventListener('click', () => {
                    const content = `<pre class="bg-slate-100 p-4 rounded-lg text-sm text-black whitespace-pre-wrap font-sans">${state.summaryData.irsResponseTemplate}</pre>
                    <button onclick="copyToClipboard(state.summaryData.irsResponseTemplate)" class="mt-4 bg-orange-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-orange-600" style="background-color: #ff6b00">Copy to Clipboard</button>`;
                    showModal('Draft IRS Response', content);
                });
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', renderView);

    </script>
</body>
</html>


